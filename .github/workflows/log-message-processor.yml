name: CI/CD - log-processor
on:
  push:
    branches: [ "master", "dev" ]
    paths:
      - "log-message-processor/**"
  pull_request:
    branches: [ "master", "dev" ]
    paths:
      - "log-message-processor/**"

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      
      - name: Setup Node.js (adjust if different language)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies (if Node.js)
        working-directory: ./log-message-processor
        run: |
          if [ -f "package.json" ]; then
            npm ci
            npm test || echo "No tests found"
          fi
      
      - name: Build Docker image
        run: docker build -t log-processor:${{ github.sha }} ./log-message-processor

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      
      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass
      
      - name: Deploy to VM
        run: |
          sshpass -p "${{ secrets.VM_PASSWORD_KEY }}" ssh -o StrictHostKeyChecking=no azureuser@${{ secrets.VM_IP_KEY }} "
            cd /opt/microservice-app-example &&
            git pull origin master &&
            docker-compose build log-processor &&
            docker-compose up -d log-processor
          "